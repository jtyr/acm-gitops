name: On tag
on:
  #  workflow_run:
  #    workflows:
  #      - On merge
  #      - On tag
  #    types:
  #      - completed
  push:
    tags:
      #- "*"
      # <app>    -<ver>               -<env>
      #- "[a-z0-9]+-[0-9]+.[0-9]+.[0-9]+-[a-z]+"
      # <app>    -<yyyy>  <mm>     <dd>       T<hh>      <mm>      <ss>      -<env>
      - "[a-z0-9]+-202[1-9][01][0-9][0123][0-9]T[012][0-9][0-5][0-9][0-5][0-9]-[a-z]+"
#    tags-ignore:
#      - "*-success"
#      - "*-fail"

jobs:
  dev:
    name: Dev
    runs-on: ubuntu-latest
    if: endsWith(github.ref, '-dev')
    environment: dev
    steps:
      - uses: actions/checkout@v2
        with:
          token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
      - name: Get env from tag
        id: env
        run: |-
          echo "::set-output name=env_name::${GITHUB_REF##*-}"
      - name: Print message
        run: |-
          echo "Generating ${{ steps.env.outputs.env_name }} files..."
      - name: Get higher env name
        id: higher_env
        run: |-
          if [[ '${{ steps.env.outputs.env_name }}' == 'dev' ]]; then
              NAME='lobdev'
          elif [[ '${{ steps.env.outputs.env_name }}' == 'lobdev' ]]; then
              NAME='uat'
          elif [[ '${{ steps.env.outputs.env_name }}' == 'uat' ]]; then
              NAME='prod'
          elif [[ '${{ steps.env.outputs.env_name }}' == 'prod' ]]; then
              NAME=''
          fi

          echo "::set-output name=env_name::$NAME"
      - name: Promote to higer env
        run: |-
          ENV=$(echo '-${{ steps.env.outputs.env_name }}')
          LEN=${#ENV}

          if [[ $LEN > 0 ]]; then
              git tag "${GITHUB_REF:0:-$LEN}-${{ steps.higher_env.outputs.env_name }}"
              git push --tags
          fi
  lobdev:
    name: LobDev
    runs-on: ubuntu-latest
    if: endsWith(github.ref, '-lobdev')
    environment: lobdev
    steps:
      - uses: actions/checkout@v2
        with:
          token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
      - name: Get env from tag
        id: env
        run: |-
          echo "::set-output name=env_name::${GITHUB_REF##*-}"
      - name: Print message
        run: |-
          echo "Generating ${{ steps.env.outputs.env_name }} files..."
      - name: Get higher env name
        id: higher_env
        run: |-
          if [[ '${{ steps.env.outputs.env_name }}' == 'dev' ]]; then
              NAME='lobdev'
          elif [[ '${{ steps.env.outputs.env_name }}' == 'lobdev' ]]; then
              NAME='uat'
          elif [[ '${{ steps.env.outputs.env_name }}' == 'uat' ]]; then
              NAME='prod'
          elif [[ '${{ steps.env.outputs.env_name }}' == 'prod' ]]; then
              NAME=''
          fi

          echo "::set-output name=env_name::$NAME"
      - name: Promote to higer env
        run: |-
          ENV=$(echo '-${{ steps.env.outputs.env_name }}')
          LEN=${#ENV}

          if [[ $LEN > 0 ]]; then
              git tag "${GITHUB_REF:0:-$LEN}-${{ steps.higher_env.outputs.env_name }}"
              git push --tags
          fi
  uat:
    name: UAT
    runs-on: ubuntu-latest
    if: endsWith(github.ref, '-uat')
    environment: uat
    steps:
      - uses: actions/checkout@v2
        with:
          token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
      - name: Get env from tag
        id: env
        run: |-
          echo "::set-output name=env_name::${GITHUB_REF##*-}"
      - name: Print message
        run: |-
          echo "Generating ${{ steps.env.outputs.env_name }} files..."
      - name: Get higher env name
        id: higher_env
        run: |-
          if [[ '${{ steps.env.outputs.env_name }}' == 'dev' ]]; then
              NAME='lobdev'
          elif [[ '${{ steps.env.outputs.env_name }}' == 'lobdev' ]]; then
              NAME='uat'
          elif [[ '${{ steps.env.outputs.env_name }}' == 'uat' ]]; then
              NAME='prod'
          elif [[ '${{ steps.env.outputs.env_name }}' == 'prod' ]]; then
              NAME=''
          fi

          echo "::set-output name=env_name::$NAME"
      - name: Promote to higer env
        run: |-
          ENV=$(echo '-${{ steps.env.outputs.env_name }}')
          LEN=${#ENV}

          if [[ $LEN > 0 ]]; then
              git tag "${GITHUB_REF:0:-$LEN}-${{ steps.higher_env.outputs.env_name }}"
              git push --tags
          fi
  prod:
    name: Prod
    runs-on: ubuntu-latest
    if: endsWith(github.ref, '-prod')
    environment: prod
    steps:
      - uses: actions/checkout@v2
        with:
          token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
      - name: Get env from tag
        id: env
        run: |-
          echo "::set-output name=env_name::${GITHUB_REF##*-}"
      - name: Print message
        run: |-
          echo "Generating ${{ steps.env.outputs.env_name }} files..."
      - name: Get higher env name
        id: higher_env
        run: |-
          if [[ '${{ steps.env.outputs.env_name }}' == 'dev' ]]; then
              NAME='lobdev'
          elif [[ '${{ steps.env.outputs.env_name }}' == 'lobdev' ]]; then
              NAME='uat'
          elif [[ '${{ steps.env.outputs.env_name }}' == 'uat' ]]; then
              NAME='prod'
          elif [[ '${{ steps.env.outputs.env_name }}' == 'prod' ]]; then
              NAME=''
          fi

          echo "::set-output name=env_name::$NAME"
      - name: Promote to higer env
        run: |-
          ENV=$(echo '-${{ steps.env.outputs.env_name }}')
          LEN=${#ENV}

          if [[ $LEN > 0 ]]; then
              git tag "${GITHUB_REF:0:-$LEN}-${{ steps.higher_env.outputs.env_name }}"
              git push --tags
          fi
